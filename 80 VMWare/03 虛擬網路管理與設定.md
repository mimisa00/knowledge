## 前言
- 第一章 ESXi安裝建置中有提到虛擬交換器的設定，此虛擬交換器即為虛擬標準交換器(Virtual Standard Switch, VSS)。
- 每部ESXi內均會包含眾多虛擬機器，VSS之目的便是為了滿足VM不同的網路需求而設計，而每部ESXi都有其獨立的VSS架構環境。
- vCenter Server做為整合ESXi的管理平台，其亦具有管理ESXi底下VSS之功能，且保留其VSS獨立架構環境之特性。這就導致vCenter仍
需各別管理VSS，如此並無減輕vCenter網路管理的負擔。因此在vCenter上便有了分散式交換器(Virtual Distributed Switch, VDS)功能，
其可套用至所有ESXi，令ESXi有一共通的網路環境。

## vSphere Client VSS設定
1. 承第一、二章建置環境，進入vSphere Client後，導覽窗格切換至「主機和叢集」頁籤，點擊10.5.10.218主機。

2. 右方畫面切換至「設定」頁籤，下方展開「網路」區塊點擊「虛擬交換器」，即顯示現階段VSS架構環境。
   <img width="729" height="389" alt="image" src="https://github.com/user-attachments/assets/ed150517-94bc-4c34-8e43-ac1dc54c9d0a" />

3. 本節目標將於vSwitch0新增2個port group，並新增1部vSwitch1，指派VMKernel連接埠IP，後續將做為掛載Storage使用。
> 最終完成設定畫面如下：
>> - vSwitch0
>> <img width="729" height="573" alt="image" src="https://github.com/user-attachments/assets/ddfd0e9e-7b18-408d-bd34-0fe7e48365be" />
>>
>> - vSwitch1
>> <img width="744" height="251" alt="image" src="https://github.com/user-attachments/assets/de996da5-81c3-4b2a-8fb1-c0d21c71475a" />

4. 接續第2點畫面，於「標準交換器：vSwitch0」旁點擊「新增網路」-> 標準交換器的虛擬機器連接埠群組 -> 選取現有的標準交換器 (vSwitch0) 後Next。

5. 連線設定畫面，網路標籤：nProd54；VLAN識別碼：54，即完成新增nProd54連接埠群組，後面vMgt比照辦理。

6. 接著新增vSwitch1，一樣點擊「新增網路」-> VMKernel 網路介面卡 -> 新增標準交換器 -> NEXT 進入建立標準交換器畫面。

7. 按「+」將vmnic2及vmnic3加入作用中介面卡，NEXT進入連接埠內容畫面。
> - 作用中介面卡：如果網路介面卡連線正常並處於作用中狀態，則繼續使用上行。
> - 待命介面卡：如果其中一個作用中實體介面卡關閉，則使用此上行。
> - 未使用的介面卡：請物使用此上行。

8. VMkernel連接埠設定如下：
> - 網路標籤：NFS_Storage
> - VLAN識別碼：929
> - TCP/IP堆疊：預設值
> - vMotion、管理、vSphere Replication：checked
> - NEXT進入IPv4設定

9. IPv4設定畫面，選「使用靜態IPv4設定」：
> - IPv4位址：10.213.10.218
> - 子網路遮罩：255.255.255.0
> - NEXT核對設定無誤後即完成。

10. 於「標準交換器：vSwitch1」旁點擊「編輯」彈出vSwitch1編輯設定視窗調整以下設定：
> - 安全性 -> 混合模式 -> 接受
> - 整併和容錯移轉 -> 負載平衡 -> 根據IP雜湊進行路由

11. 如此即完成體驗區機房VMware網路環境設定。
12. 於vSphere Client導覽窗格「網路」頁籤中，會列出所有ESXi內的port group，不同ESXi內的port group若為相同名稱、大小寫一致，vCenter會視為相同之物件。
因此若ESXi A有port group：nProd54，VLAN：54；ESXi B有port group：nprod54，VLAN：54，僅管其具有相同VLAN，VM彼此可互通，但vCenter仍視此為不同物件。
若A、B均具有nProd54的port group，但VLAN分別為54、50，因vCenter是依名稱決定物件，因此其會認定此為同一物件，進而導致使用此port group之VM網路異常。

## vSphere Client VDS設定
1. 先前介紹VDS時僅簡短提到其可整合vCenter環境底下ESXi之網路，但實際上VDS相比VSS具有更多的功能，比較如下：
<img width="580" height="831" alt="image" src="https://github.com/user-attachments/assets/693766ad-4088-46d1-a935-6909f7892188" />

2. 由上表可知VDS具有更完善的功能，只是VDS須額外購買相關授權。
3. 欲將ESXi從VSS轉移至VDS時，其實體主機及VM之網路會發生瞬間中斷並恢復。在通常狀況下對網路服務並不會有太大影響，但此一特性對現階段的架構卻反倒有些不友善。
4. 下面會先介紹VDS的設定及轉移，並在vCenter Server額外新增1部ESXi主機，IP：10.5.10.216。待瞭解VDS設定步驟後會再說明不友善之原因。

5. 設定步驟：
> a. 導覽窗格點擊「Datacenter」，右方點擊「動作」->「Distributed Switch」->「新增Distributed Switch」。
>> - 名稱：DSwitch
>> - 選取版本：6.5.0 - ESXi 6.5及更新版本
>> - 設定組態：
>>>> - 上行數目：4
>>>> - 連接埠群組名稱：mgmt-d
>> - 即完成VDS新增
>
> b. 目前VSS上共有mgmt、nProd54、VM Network、vMgt等四個port group及Management Network及NFS_Storage 二個VMKernel。
> 
> VSS上VMKernel port與port group是分開的；但VDS是合在一起共用的。故針對VDS，將新增mgmt-d、nProd54-d、
> 
> VM Network-d、vMgt及NFS_Storage-d等5個distributed port group，其中mgmt-d於新增VDS時便已產生。
>
> c. 導覽窗格切換至「網路」頁籤，點擊「DSwitch」，右方畫面點擊「動作」->「分散式連接埠群組」->「新增分散式連接埠群組」。
>> i. 名稱：NFS_Storage-d
>> 
>> ii. 設定組態：
>>>> - VLAN類型：VLAN
>>>> - VLAN識別碼：929
>>>> - 自訂預設原則組態：checked
>>>> - 
>> iii. 安全性：全接受

>> iv. 整併和容錯移轉：
>>>> - 負載平衡：根據IP雜湊進行路由
>>>> - 容錯移轉順序：
>>>>>> - 作用中上行：上行3、上行4
>>>>>> - 未使用的上行：上行1、上行2
>>>>>> - 
>> v. 餘分散式連接埠群組比照上述及VSS之參數設定，作用中上行為1、2；未使用上行為3、4，mgmt-d亦需再編輯修正，設定完如下圖。
>> <img width="734" height="541" alt="image" src="https://github.com/user-attachments/assets/380127de-a118-4ad3-b6a8-e6ae75264f7c" />
>
> d. 接著將ESXi主機由VSS轉移至VDS。一樣點擊「動作」->「新增和管理主機」
>> i. 選取工作：新增主機
>> 
>> ii. 選取主機：新增主機，將10.5.10.216加入
>> 
>> iii. 管理實體介面卡：指派上行，將vmnic0~3分別指派至上行1~4
>> 
>> iv. 管理VMkernel介面卡：將vmk0指派給mgmt-d；vmk1指派給NFS_Storage-d
>> 
>> v. 移轉虛擬機器網路：將10.5.10.216內含之虛擬機，將其網路指派至相對應之distributed port group
>>
> e. 如此即完成VDS的設定與ESXi的轉移。

6. VSS轉移至VDS，依順序是將VSS的uplinks移至VDS，接續為VMKernel，最後才是VM。故在uplinks轉移至VDS的瞬間會造成網路短暫中斷，
等VDS連接uplinks後，VMkernel再轉移過去，即可正常存取ESXi伺服器，但此時VM還在VSS上，故需將VM移至VDS後網路始恢復正常運作。

7. 現行環境將ESXi及vCenter轉移至VDS時，先將uplinks切換至VDS，如此便導致ESXi斷線，vCenter也因此斷線，作業便無法繼續，因而導致
轉移失敗。畢竟是藉vCenter平台作業，必需確保其網路的穩定性。因此vCenter由VSS轉移VDS時，其所屬計算資源的ESXi至少需有2組以上
uplinks且具failover。轉移時先將1組uplink移至VDS，此時尚有1組uplink連接VSS，ESXi網路不會因此中斷，這時再轉移VMKernel及vCenter，
最後再將剩餘的uplinks轉移至VDS。
